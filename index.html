<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Payment Status</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f4f4f9;
            margin: 0; 
            display: flex;
            justify-content: center;
            align-items: center;
            height: 90vh;
        }

        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            overflow: hidden; /* Prevent overflowing */
        }

        .table-container {
            max-height: 600px; /* Height for the table container */
            overflow-y: auto; /* Vertical scrollbar */
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        #buttonContainer {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        #addRow, #deleteRows {
            display: none;
        }

        button {
            padding: 6px 10px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }

        .total {
            margin-top: 15px;
            font-weight: bold;
            font-size: 1.0em;
            color: #333;
            text-align: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 8px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid #ddd;
        }

        th {
            background-color: #007bff;
            color: #fff;
        }

        td {
            background-color: #fff;
            transition: background-color 0.3s;
        }

        td:hover {
            background-color: #f1f1f1;
        }

        .delete-btn {
            cursor: pointer;
            color: #e74c3c;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.15em;
        }

        .confirmation-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .dialog-box {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .dialog-box button {
            margin: 5px;
        }

        /* Skeleton loader styles */
        .skeleton-loader {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh; /* Full height for centering */
            width: 100%; /* Full width to cover */
            position: absolute; /* Position absolute to center */
            top: 0; /* Align to top */
            left: 0; /* Align to left */
            background-color: rgba(255, 255, 255, 0.8); /* Light background for loader */
            z-index: 9998; /* Below dialog */
        }

        .skeleton {
            height: 20px;
            width: 300px;
            background: #e0e0e0;
            border-radius: 4px;
            animation: pulse 1.5s infinite;
            margin: 5px 0; /* Margin between skeletons */
        }

        @keyframes pulse {
            0% { opacity: 0.3; }
            50% { opacity: 1; }
            100% { opacity: 0.3; }
        }

        @media (max-width: 600px) {
            button {
                width: calc(50% - 5px);
                font-size: 0.8em;
            }

            table {
                font-size: 0.9em;
            }

            th, td {
                padding: 10px;
            }

            .total {
                font-size: 1.2em;
            }
        }

    </style>
</head>

<body>
    <div class="skeleton-loader" id="skeletonLoader">
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <h1>Payment Status</h1>
        <div id="buttonContainer">
            <button id="toggleButtons"><i class="fas fa-eye"></i> Show Buttons</button>
            <button id="addRow"><i class="fas fa-plus"></i> Add Row</button>
            <button id="deleteRows"><i class="fas fa-trash"></i> Delete All Rows</button>
        </div>
        <div class="total">
            Total Amount: <span id="totalAmount">0</span>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Sr No</th>
                        <th>Name</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Dynamic rows will be added here -->
                </tbody>
            </table>
        </div>
    </div>

    <div class="confirmation-dialog" id="confirmationDialog">
        <div class="dialog-box">
            <p>Are you sure you want to delete all rows?</p>
            <button id="confirmDelete">Yes</button>
            <button id="cancelDelete">No</button>
        </div>
    </div>

    <div class="confirmation-dialog" id="rowConfirmationDialog">
        <div class="dialog-box">
            <p>Are you sure you want to delete this row?</p>
            <button id="confirmRowDelete">Yes</button>
            <button id="cancelRowDelete">No</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-analytics.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDjgXM4Cei5UnSl1d5vaDkquGnVRPhgipM",
            authDomain: "payment-status-b5e0e.firebaseapp.com",
            projectId: "payment-status-b5e0e",
            storageBucket: "payment-status-b5e0e.appspot.com",
            messagingSenderId: "635056081890",
            appId: "1:635056081890:web:882bc5cb47799549bf47bb",
            measurementId: "G-VKM2VKED9E"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        let rowToDelete = null;

        document.getElementById('toggleButtons').addEventListener('click', function () {
            const addRowButton = document.getElementById('addRow');
            const deleteRowsButton = document.getElementById('deleteRows');
            const isHidden = addRowButton.style.display === 'none';

            addRowButton.style.display = isHidden ? 'inline-block' : 'none';
            deleteRowsButton.style.display = isHidden ? 'inline-block' : 'none';
            this.innerHTML = isHidden ? '<i class="fas fa-eye-slash"></i> Hide Buttons' : '<i class="fas fa-eye"></i> Show Buttons';
        });

        document.getElementById('addRow').addEventListener('click', async function () {
            const tableBody = document.getElementById('tableBody');
            const rowCount = tableBody.getElementsByTagName('tr').length + 1;
            const newRow = document.createElement('tr');

            newRow.innerHTML = `
                <td>${rowCount}</td>
                <td contenteditable="true" oninput="this.innerText = this.innerText.toUpperCase(); keepCursorPosition(this)"></td>
                <td contenteditable="true" onkeypress="return isNumberKey(event)" oninput="updateAmount(this)"></td>
                <td onclick="toggleStatus(this)">Pending</td>
                <td><i class="fas fa-trash delete-btn" onclick="confirmRowDelete(this)"></i></td>
            `;
            tableBody.appendChild(newRow);

            // Add new row to Firebase
            try {
                const docRef = await addDoc(collection(db, "paymentRows"), {
                    srNo: rowCount,
                    name: "",
                    amount: "",
                    status: "Pending"
                });
                newRow.dataset.id = docRef.id;
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        });

        document.getElementById('deleteRows').addEventListener('click', function () {
            document.getElementById('confirmationDialog').style.display = 'flex';
        });

        document.getElementById('confirmDelete').addEventListener('click', async function () {
            const tableBody = document.getElementById('tableBody');
            const rows = tableBody.getElementsByTagName('tr');

            // Delete all documents from Firebase
            for (let row of rows) {
                if (row.dataset.id) {
                    try {
                        await deleteDoc(doc(db, "paymentRows", row.dataset.id));
                    } catch (e) {
                        console.error("Error deleting document: ", e);
                    }
                }
            }

            tableBody.innerHTML = '';
            updateTotal();
            document.getElementById('confirmationDialog').style.display = 'none';
        });

        document.getElementById('cancelDelete').addEventListener('click', function () {
            document.getElementById('confirmationDialog').style.display = 'none';
        });

        window.confirmRowDelete = function(icon) {
            rowToDelete = icon.closest('tr');
            document.getElementById('rowConfirmationDialog').style.display = 'flex';
        };

        document.getElementById('confirmRowDelete').addEventListener('click', async function () {
            if (rowToDelete) {
                if (rowToDelete.dataset.id) {
                    try {
                        await deleteDoc(doc(db, "paymentRows", rowToDelete.dataset.id));
                    } catch (e) {
                        console.error("Error deleting document: ", e);
                    }
                }
                rowToDelete.remove();
                updateSrNo();
                updateTotal();
                rowToDelete = null;
            }
            document.getElementById('rowConfirmationDialog').style.display = 'none';
        });

        document.getElementById('cancelRowDelete').addEventListener('click', function () {
            document.getElementById('rowConfirmationDialog').style.display = 'none';
            rowToDelete = null;
        });

        window.toggleStatus = async function(td) {
            const newStatus = (td.innerText === "Pending") ? "Done" : "Pending";
            td.innerText = newStatus;

            const row = td.parentElement;
            if (row.dataset.id) {
                try {
                    await updateDoc(doc(db, "paymentRows", row.dataset.id), {
                        status: newStatus
                    });
                } catch (e) {
                    console.error("Error updating document: ", e);
                }
            }
        };

        window.isNumberKey = function(evt) {
            const charCode = (evt.which) ? evt.which : evt.keyCode;
            return !(charCode > 31 && (charCode < 48 || charCode > 57));
        };

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        window.updateAmount = async function(input) {
            const originalValue = input.innerText.replace(/,/g, '');
            let formattedValue = '';

            if (originalValue === "" || isNaN(originalValue)) {
                formattedValue = "";
            } else {
                formattedValue = formatNumber(Math.floor(originalValue));
            }

            setTimeout(() => {
                const range = document.createRange();
                const selection = window.getSelection();
                range.selectNodeContents(input);
                range.collapse(false);
                selection.removeAllRanges();
                selection.addRange(range);
            }, 0);

            input.innerText = formattedValue;
            updateTotal();

            const row = input.parentElement;
            if (row.dataset.id) {
                try {
                    await updateDoc(doc(db, "paymentRows", row.dataset.id), {
                        amount: formattedValue
                    });
                } catch (e) {
                    console.error("Error updating document: ", e);
                }
            }
        };

        window.keepCursorPosition = function(input) {
            setTimeout(() => {
                const range = document.createRange();
                const selection = window.getSelection();
                range.selectNodeContents(input);
                range.collapse(false);
                selection.removeAllRanges();
                selection.addRange(range);
            }, 0);
        };

        function updateTotal() {
            const tableBody = document.getElementById('tableBody');
            const rows = tableBody.getElementsByTagName('tr');
            let total = 0;

            for (let row of rows) {
                const amountCell = row.cells[2].innerText.replace(/,/g, '');
                if (!isNaN(amountCell) && amountCell !== "") {
                    total += parseInt(amountCell, 10);
                }
            }

            document.getElementById('totalAmount').innerText = formatNumber(total);
        }

        function updateSrNo() {
            const tableBody = document.getElementById('tableBody');
            const rows = tableBody.getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                rows[i].cells[0].innerText = i + 1;
                // Update Sr No in Firebase
                if (rows[i].dataset.id) {
                    updateDoc(doc(db, "paymentRows", rows[i].dataset.id), {
                        srNo: i + 1
                    });
                }
            }
        }

        // Load data from Firebase on page load
        async function loadDataFromFirebase() {
            const querySnapshot = await getDocs(collection(db, "paymentRows"));
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            let rows = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                rows.push({id: doc.id, ...data});
            });

            // Sort rows by srNo
            rows.sort((a, b) => a.srNo - b.srNo);

            rows.forEach((data, index) => {
                const newRow = document.createElement('tr');
                newRow.dataset.id = data.id;

                newRow.innerHTML = `
                    <td>${index + 1}</td>
                    <td contenteditable="true" oninput="this.innerText = this.innerText.toUpperCase(); keepCursorPosition(this)">${data.name}</td>
                    <td contenteditable="true" onkeypress="return isNumberKey(event)" oninput="updateAmount(this)">${data.amount}</td>
                    <td onclick="toggleStatus(this)">${data.status}</td>
                    <td><i class="fas fa-trash delete-btn" onclick="confirmRowDelete(this)"></i></td>
                `;
                tableBody.appendChild(newRow);
            });

            // Show the main container and hide the loader
            document.getElementById('mainContainer').style.display = 'block';
            document.getElementById('skeletonLoader').style.display = 'none'; // Hide loader
            updateTotal();
        }

        // Call loadDataFromFirebase when the page loads
        window.addEventListener('load', loadDataFromFirebase);

        // Update Firebase when name is changed
        document.getElementById('tableBody').addEventListener('blur', async function(event) {
            if (event.target.cellIndex === 1) { // Name column
                const row = event.target.parentElement;
                if (row.dataset.id) {
                    try {
                        await updateDoc(doc(db, "paymentRows", row.dataset.id), {
                            name: event.target.innerText.toUpperCase()
                        });
                    } catch (e) {
                        console.error("Error updating document: ", e);
                    }
                }
            }
        }, true);
    </script>
</body>
</html>
